<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard – TallyInsight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="page">

  <!-- ===== Header ===== -->
  <header>
    <div class="container header-inner">
      <div class="logo">TallyInsight</div>
      <button class="btn btn-outline" onclick="logout()">Logout</button>
    </div>
  </header>

  <section class="hero">
    <div class="container" style="max-width:800px;">

      <!-- =====================
           COMPANY CONTEXT
      ====================== -->
      <div class="card">
        <h2 id="companyName">Company</h2>
        <p class="muted">Company dashboard</p>
      </div>

      <!-- =====================
           SUBSCRIPTION SUMMARY
      ====================== -->
      <div class="card" style="margin-top:20px;">
        <h3>Subscription</h3>

        <div class="row">
          <span>Status</span>
          <strong id="subStatus">—</strong>
        </div>

        <div class="row">
          <span>Valid Till</span>
          <strong id="subValid">—</strong>
        </div>

        <button
          id="subAction"
          class="btn btn-primary"
          style="margin-top:12px;"
          onclick="subscriptionAction()"
        >
          —
        </button>
      </div>

      <!-- =====================
           AGENT STATUS
      ====================== -->
      <div class="card" style="margin-top:20px;">
        <h3>Agent</h3>

        <p id="agentStatus" class="muted">Checking agent status…</p>

        <button
          id="agentBtn"
          class="btn btn-outline"
          style="margin-top:12px; display:none;"
          onclick="location.href='agent-install.html'"
        >
          Install Agent
        </button>
      </div>

    </div>
  </section>

  <footer>© TallyInsight</footer>
</div>

<script>
const API = 'https://tallyinsight-backend-1.onrender.com';
const userId = localStorage.getItem('x-user-id');
const companyId = localStorage.getItem('x-company-id');

if (!userId || !companyId) {
  location.href = 'login.html';
}

/* =========================
   LOAD SUBSCRIPTION
========================= */
let currentStatus = null;

fetch(`${API}/subscriptions/status`, {
  headers: {
    'x-user-id': userId,
    'x-company-id': companyId
  }
})
.then(r => r.json())
.then(sub => {
  currentStatus = sub.status;

  document.getElementById('subStatus').textContent = sub.status;
  document.getElementById('subValid').textContent =
    sub.expiry_date || sub.trial_end || '—';

  const btn = document.getElementById('subAction');

  if (sub.status === 'TRIAL') {
    btn.textContent = 'Install Agent';
  } else if (sub.status === 'ACTIVE') {
    btn.textContent = 'View Subscription';
  } else {
    btn.textContent = 'Renew Subscription';
  }
})
.catch(() => {
  document.getElementById('subStatus').textContent = 'Unavailable';
});

/* =========================
   AGENT STATUS (SAFE)
========================= */
fetch(`${API}/sync/last`, {
  headers: {
    'x-user-id': userId,
    'x-company-id': companyId
  }
})
.then(r => r.ok ? r.json() : Promise.reject())
.then(data => {
  if (!data.last_sync_at) {
    document.getElementById('agentStatus').textContent =
      'Agent not connected';
    document.getElementById('agentBtn').style.display = 'block';
    return;
  }

  const d = new Date(data.last_sync_at);
  document.getElementById('agentStatus').textContent =
    'Last sync: ' + d.toLocaleString();
})
.catch(() => {
  document.getElementById('agentStatus').textContent =
    'Agent not connected';
  document.getElementById('agentBtn').style.display = 'block';
});

/* =========================
   ACTIONS
========================= */
function subscriptionAction() {
  if (currentStatus === 'TRIAL') {
    location.href = 'agent-install.html';
  } else {
    location.href = 'subscription.html';
  }
}

function logout() {
  localStorage.clear();
  location.href = 'login.html';
}
</script>

</body>
</html>