<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TallyInsight Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f7f9;
      padding: 30px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .label { color:#6b7280; }
    .value { font-weight:600; }
    button {
      padding: 10px 14px;
      margin-right: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .primary { background:#2563eb; color:white; }
    .secondary { background:#374151; color:white; }
    .danger { background:#dc2626; color:white; }
  </style>
</head>

<body>

<!-- =========================
     COMPANY INFO
========================= -->
<div class="card">
  <h2>Company Overview</h2>

  <div class="row">
    <div class="label">Company</div>
    <div class="value" id="companyName">—</div>
  </div>

  <div class="row">
    <div class="label">Subscription</div>
    <div class="value" id="subscriptionStatus">—</div>
  </div>

  <div class="row">
    <div class="label">Valid Till</div>
    <div class="value" id="subscriptionExpiry">—</div>
  </div>

  <div class="row">
    <div class="label">Agent Installed</div>
    <div class="value" id="agentStatus">—</div>
  </div>

  <div class="row">
    <div class="label">Last Stock Sync</div>
    <div class="value" id="lastSync">—</div>
  </div>
</div>

<!-- =========================
     ACTIONS
========================= -->
<div class="card">
  <h3>Actions</h3>

  <button class="primary" onclick="location.href='images.html'">
    Manage Item Images
  </button>

  <button class="secondary" onclick="location.href='users.html'">
    Manage Users
  </button>

  <button class="secondary" onclick="location.href='subscription.html'">
    Subscription
  </button>
</div>

<button class="danger" onclick="logout()">Logout</button>

<script>
const API = 'https://tallyinsight-backend-1.onrender.com';
const userId = localStorage.getItem('x-user-id');
const companyId = localStorage.getItem('x-company-id');

if (!userId || !companyId) {
  location.href = 'index.html';
}

/* =========================
   GUARD + LOAD
========================= */
async function init() {
  // subscription
  const sub = await fetch(`${API}/subscription/status`, {
    headers: { 'x-user-id': userId, 'x-company-id': companyId }
  }).then(r => r.json());

  if (sub.status === 'NO_SUBSCRIPTION') {
    location.href = 'subscription.html';
    return;
  }

  document.getElementById('subscriptionStatus').textContent = sub.status;
  document.getElementById('subscriptionExpiry').textContent =
    sub.expiry_date || sub.trial_end || '—';

  // agent
  const devices = await fetch(`${API}/admin/devices`, {
    headers: { 'x-user-id': userId, 'x-company-id': companyId }
  }).then(r => r.json());

  if (!devices || devices.length === 0) {
    location.href = 'agent-install.html';
    return;
  }

  document.getElementById('agentStatus').textContent = 'Yes';

  // company name
  const mine = await fetch(`${API}/companies/mine`, {
    headers: { 'x-user-id': userId }
  }).then(r => r.json());

  const company = (mine.companies || [])
    .find(c => c.company_id === companyId);

  if (company) {
    document.getElementById('companyName').textContent =
      company.company_name;
  }

  // last sync
  const sync = await fetch(`${API}/sync/last`, {
    headers: { 'x-user-id': userId, 'x-company-id': companyId }
  }).then(r => r.json());

  document.getElementById('lastSync').textContent =
    sync.last_sync_at
      ? new Date(sync.last_sync_at).toLocaleString()
      : 'Never';
}

init();

function logout() {
  localStorage.clear();
  location.href = 'index.html';
}
</script>

</body>
</html>
